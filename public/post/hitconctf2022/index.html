<!doctype html>
<html
  lang="en-us" 
  
    data-theme-mode="true"
  
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>







  

<title>
  HITCON CTF 2022 | Le Phu Duc
</title>
<meta
  name="description"
  content="Write up for rev problem in HITCON CTF 2022"
/>



  <script>
  (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
  })(window, document, "clarity", "script", "true");
</script>


  
<script src="https://www.googletagmanager.com/gtag/js?id=true"></script>
<script data-pjax>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
    dataLayer.push(arguments);
  }

  gtag('js', new Date());

  gtag('config', 'true');
</script>








<script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"clipboard\":{\"copyright\":{\"content\":\"All articles in this blog are licensed under BY-NC-SA unless otherwise stated. Please indicate the source when reprinting!\",\"count\":50,\"enable\":false},\"fail\":\"Failed to copy (ﾟ⊿ﾟ)ﾂ\",\"success\":\"Copied\"},\"code_block\":{\"expand\":true},\"icon_font\":\"4552607_0khxww3tj3q9\",\"outdate\":{\"daysago\":180,\"enable\":false,\"message\":\"本文最后更新于 {time}，请注意文中内容可能已经发生变化。\"}}");
</script>











  
  
  
    
  

  
  
  
    
  

  
  
  
    
  

  
  
  
    
  

  
  
  


<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7cUbuntu%20Mono:400,400italic,700,700italic%7cSource%20Code%20Pro:400,400italic,700,700italic%7cJetBrains%20Mono:400,400italic,700,700italic&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7cUbuntu%20Mono:400,400italic,700,700italic%7cSource%20Code%20Pro:400,400italic,700,700italic%7cJetBrains%20Mono:400,400italic,700,700italic&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>






  <link
    rel="preload"
    href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2"
    as="font"
    type="font/woff2"
    crossorigin="anonymous"
  />



  






 <link rel="stylesheet" href="/css/loader.css" />







<link rel="shortcut icon" href="/favicon/favicon.ico">







 <link rel="stylesheet" href="/css/main.css" />





  <link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    onload="this.onload=null;this.rel='stylesheet'"
  />






  <link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.9/dist/katex.min.css"
    onload="this.onload=null;this.rel='stylesheet'"
  />








  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    
    
    
    
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"
  ></script>





  


  <link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css" />








  <link rel="stylesheet" href="https://npm.webcache.cn/aplayer@1.10.1/dist/APlayer.min.css" />



  </head>
  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <img src="/images/loading-golden.png" alt="loading" />
        
      </div>
      <div class="loading-word"></div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>


<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        
<div id="header-nav">
  <nav id="main-nav">
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon '>
          
            &#xe632;
          
        </div>
        <a class="main-nav-link" href="/">Home</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon '>
          
            &#xe628;
          
        </div>
        <a class="main-nav-link" href="/about">About</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon '>
          
            &#xe604;
          
        </div>
        <a class="main-nav-link" href="/archives">Archives</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon '>
          
            &#xe621;
          
        </div>
        <a class="main-nav-link" href="/achievements">Achievements</a>
      </span>
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
    
  </nav>
</div>
<header id="header">
  
    
    <picture></picture>
      <img fetchpriority="high" src="/images/post_covers/hitconctf2022.jpeg" alt="HITCON CTF 2022">
    
  

  <div id="header-outer">
    <div id="header-title">
      
        
        
          
        
  
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">HITCON CTF 2022</h1>
          </a>
        
      
  
      
        
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>
        <div id="content"
          class="sidebar-left"
            >
          <aside id="sidebar">
  
    <div id="aplayer" theme="var(--color-link)" data-aos="fade-up"></div>
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    >
      
        <div class="sidebar-toc-sidebar">
          <div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#file-checkerexe">file checker.exe</a></li>
    <li><a href="#file-checker_drvsys">file checker_drv.sys</a></li>
    <li><a href="#take-note">take note</a></li>
    <li><a href="#solution">Solution</a></li>
  </ul>
</nav>
  </div>
</div>
        </div>
        <div class="sidebar-common-sidebar hidden">
          
<div class="sidebar-author">
  <img
    data-src="/avatar/shiba.jpg"
    data-sizes="auto"
    alt="Le Phu Duc"
    class="lazyload"
  />
  <div class="sidebar-author-name">Le Phu Duc</div>
  <div class="sidebar-description">a.k.a Jinn</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    
    <div class="sidebar-state-number">16</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">
      1
    </div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">6</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-discord sidebar-social-icon">
      <a
        href="https://discordapp.com/users/lephuduc"
        itemprop="url"
        target="_blank"
        aria-label="discord"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-facebook sidebar-social-icon">
      <a
        href="https://www.facebook.com/lephuduc0309"
        itemprop="url"
        target="_blank"
        aria-label="facebook"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/lephuduc"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-instagram sidebar-social-icon">
      <a
        href="https://www.instagram.com/le.phuduc"
        itemprop="url"
        target="_blank"
        aria-label="instagram"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-linkedin sidebar-social-icon">
      <a
        href="https://www.linkedin.com/in/lephuduc"
        itemprop="url"
        target="_blank"
        aria-label="linkedin"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-twitter sidebar-social-icon">
      <a
        href="https://twitter.com/lephuduck"
        itemprop="url"
        target="_blank"
        aria-label="twitter"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe632;
        
      </div>
      <div class="sidebar-menu-link">Home</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="About"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe628;
        
      </div>
      <div class="sidebar-menu-link">About</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe604;
        
      </div>
      <div class="sidebar-menu-link">Archives</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/achievements"
        aria-label="Achievements"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe621;
        
      </div>
      <div class="sidebar-menu-link">Achievements</div>
    </div>
  
</div>

        </div>
      

      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  <div class="sidebar-widget">
    
  </div>
</aside>

          <section id="main">
  <article
  class="h-entry article"
  itemprop="blogPost"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta">
      <div class="article-date">
  <a
    href="http://localhost:1313/post/hitconctf2022/"
    class="article-date-link"
    data-aos="zoom-in"
  >
    <time datetime="2022-11-27 00:00:00 &#43;0000 UTC" itemprop="datePublished"
      >2022-11-27</time
    >
    <time style="display: none;" id="post-update-time"
      >2022-11-27</time
    >
  </a>
</div>

      <div class="article-category">
  
    <a
      class="article-category-link"
      href="/categories/writeup"
      data-aos="zoom-in"
      >WRITEUP</a
    >
  
</div>

    </div>
    <div class="hr-line"></div>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <p>Đây sẽ là write-up về trải nghiệm cá nhân mình khi tham gia giải <a href="https://scoreboard.hitconctf.com/campaigns/1">HITCON CTF 2022</a>. Đầu tiên, có một bất ngờ nhỏ đối với mình là bài mình làm đa số rất nhiều solve nhưng cách giải thì không đơn giản như mình nghĩ. (giải 100kg:v)
Nhưng nhờ vậy mà qua giải này mình đã được mở mang kiến thức khá là nhiều, đặt biệt là mình đã học được cách debug windows drivers, thứ mà trước giờ mình chỉ static analysis, hơn nữa hiểu hơn về cách hoạt động của driver và biết được thêm 1 số kĩ thuật như <a href="https://www.malwarebytes.com/blog/news/2018/01/a-coin-miner-with-a-heavens-gate">Heaven&rsquo;s gate</a> trong malware.</p>
<p><img src="https://i.imgur.com/Jo4Fmcz.png" alt=""></p>
<h1 id="checker---198pts">
<a class="header-anchor" href="#checker---198pts"></a>
checker - 198pts
</h1><p>Có thể nói, đây là câu mà đa số các top team đều làm nó đầu tiên, vì trông nó rất là dễ, nhưng vì lúc này mình còn thiếu kiến thức nên giải quyết mọi chuyện có phần hơi khó khăn:v</p>
<p>Đây cũng không phải là lần đầu mình làm bài có driver trước đó, mình đã từng làm một bài driver từ giải WMCTF <a href="https://lephuduc.github.io/WMCTF2022/">tại đây</a>. Nhưng khác với những giải trước, thứ mà mình có thể static analysis hoàn toàn để ra flag riêng với bài này, setup một debugger là điều BẮT BUỘC để có flag một cách hợp lí nhất.</p>
<p><img src="https://i.imgur.com/ZcuD1id.png" alt=""></p>
<p>Đây là toàn bộ những gì đề cho mình, cơ bản là có 1 file PE và 1 file driver .sys, tại đây cũng có thể đoán rằng luồn thực thi cũng như check flag chắc chắn sẽ nằm chủ yếu ở file .sys, và tất nhiên lúc mình chạy kiểm file checker.exe thì nó báo là <code>driver not found</code></p>
<h2 id="file-checkerexe">
<a class="header-anchor" href="#file-checkerexe"></a>
file checker.exe
</h2><p><code>checker.exe</code> là file PE64 bình thường và đây là toàn bộ code của nó, mình cũng không phân tích gì nhiều ở file này.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">HANDLE</span> <span class="n">FileW</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// rcx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">OutBuffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [rsp+40h] [rbp-18h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">DWORD</span> <span class="n">BytesReturned</span><span class="p">;</span> <span class="c1">// [rsp+44h] [rbp-14h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">FileW</span> <span class="o">=</span> <span class="nf">CreateFileW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">hitcon_checker&#34;</span><span class="p">,</span> <span class="mh">0xC0000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="mi">4u</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140003620</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="n">FileW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">FileW</span> <span class="o">==</span> <span class="p">(</span><span class="n">HANDLE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="n">i64</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sub_140001010</span><span class="p">(</span><span class="s">&#34;driver not found</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">OutBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">FileW</span><span class="p">,</span> <span class="mh">0x222080u</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OutBuffer</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="s">&#34;correct</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">OutBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">v4</span> <span class="o">=</span> <span class="s">&#34;wrong</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">sub_140001010</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Cơ bản là nó yêu cầu device có tên là <code>hitcon_checker</code>, sau đó nó dùng DeviceIoControl() để tương tác với driver này.</p>
<p>Mình có đọc document về hàm này <a href="https://learn.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">tại đây</a> và nó có structure như sau:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">DeviceIoControl</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">HANDLE</span>       <span class="n">hDevice</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>        <span class="n">dwIoControlCode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPVOID</span>       <span class="n">lpInBuffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>        <span class="n">nInBufferSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>     <span class="n">LPVOID</span>       <span class="n">lpOutBuffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>        <span class="n">nOutBufferSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>     <span class="n">LPDWORD</span>      <span class="n">lpBytesReturned</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPOVERLAPPED</span> <span class="n">lpOverlapped</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><p>Riêng về chổ này mình chỉ cần nhớ tham số <code>dwIoControlCode</code>, thứ mà sẽ sử dụng để driver xử lí theo đúng tín hiệu này, và tham số trả về <code>lpBytesReturned</code>, nếu bằng 1, xem như mình check đúng.</p>
<p>Có một điều khá là lạ khi mà không có chổ để mình nhập input, chỉ có gửi code cho driver và nhận bytes trả về thôi.</p>
<h2 id="file-checker_drvsys">
<a class="header-anchor" href="#file-checker_drvsys"></a>
file checker_drv.sys
</h2><p>Đây là toàn bộ code của hàm main</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="n">sub_140001B50</span><span class="p">(</span><span class="n">struct</span> <span class="n">_DRIVER_OBJECT</span> <span class="o">*</span><span class="n">driverObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="ne">int</span> <span class="n">v2</span><span class="p">;</span> <span class="o">//</span> <span class="n">edi</span>
</span></span><span class="line"><span class="cl">  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">DriverSection</span><span class="p">;</span> <span class="o">//</span> <span class="n">rcx</span>
</span></span><span class="line"><span class="cl">  <span class="n">PHYSICAL_ADDRESS</span> <span class="n">PhysicalAddress</span><span class="p">;</span> <span class="o">//</span> <span class="n">rax</span>
</span></span><span class="line"><span class="cl">  <span class="n">PHYSICAL_ADDRESS</span> <span class="n">v5</span><span class="p">;</span> <span class="o">//</span> <span class="n">rax</span>
</span></span><span class="line"><span class="cl">  <span class="n">unsigned</span> <span class="n">__int8</span> <span class="n">v6</span><span class="p">;</span> <span class="o">//</span> <span class="n">al</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDRIVER_UNLOAD</span><span class="p">)</span><span class="n">unload_func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="n">Create_n_Init</span><span class="p">(</span><span class="n">driverObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDRIVER_DISPATCH</span><span class="p">)</span><span class="n">proc_func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDRIVER_DISPATCH</span><span class="p">)</span><span class="n">proc_func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDRIVER_DISPATCH</span><span class="p">)</span><span class="n">proc_func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDRIVER_DISPATCH</span><span class="p">)</span><span class="n">proc_func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">DriverSection</span> <span class="o">=</span> <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">DriverSection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">driverObj</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDRIVER_DISPATCH</span><span class="p">)</span><span class="n">proc_func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">DriverSection</span><span class="p">[</span><span class="mi">104</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_140001040</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">PhysicalAddress</span> <span class="o">=</span> <span class="n">MmGetPhysicalAddress</span><span class="p">((</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sub_140001490</span> <span class="o">+</span> <span class="mi">7024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140013170</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int64</span><span class="p">)</span><span class="n">MmMapIoSpace</span><span class="p">(</span><span class="n">PhysicalAddress</span><span class="p">,</span> <span class="mh">0x1000</span><span class="n">ui64</span><span class="p">,</span> <span class="n">MmNonCached</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140013178</span> <span class="o">=</span> <span class="n">qword_140013170</span> <span class="o">+</span> <span class="mi">48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v5</span> <span class="o">=</span> <span class="n">MmGetPhysicalAddress</span><span class="p">((</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sub_140001490</span> <span class="o">-</span> <span class="mi">96</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140013188</span> <span class="o">=</span> <span class="p">(</span><span class="n">__int64</span><span class="p">)</span><span class="n">MmMapIoSpace</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="mh">0x1000</span><span class="n">ui64</span><span class="p">,</span> <span class="n">MmNonCached</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">susBytes</span> <span class="o">=</span> <span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">1792</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="n">sub_140001490</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">susBytes</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">qword_140013188</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">susBytes</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">17</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">19</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">21</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">22</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">25</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">26</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">27</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sub_1400014B0</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Mình đã rename một số hàm, tuy nhiên một số biến nhưng mà mình chỉ cần phân tích một phần và hiểu là được.</p>
<p>Đầu tiên, driverObj có một thuộc tính là <code>DriverUnload</code>, đây sẽ là hàm được driver gọi lúc driver stop, có thể xem như là một destructor trong c++</p>
<p>Bỏ qua dòng thứ 10, tiếp xem là thuộc tính <code>MajorFunction</code>, mình dựa theo list này và hiểu cơ bản như sau:
<img src="https://i.imgur.com/RC4q8XS.png" alt="">
Major function sẽ dựa vào IRP_MJ_* để xác định chức năng nào sẽ được hàm nào xử lí. Hay nói cách khác <code>MajorFunction[14]</code> hoặc DEVICE_CONTROL sẽ được <code>proc_func</code> (mình đã rename) đảm nhiệm, tương tự với CREATE, CLOSE,..</p>
<p>Có thể nói, <code>proc_func</code> sẽ là hàm xử lí khi giao tiếp với <code>checker.exe</code> lúc nãy, nhưng mình sẽ nói về hàm này sau, vì nó cũng không quá rắc rối.</p>
<p>Tiếp tục với hàm main,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">PhysicalAddress</span> <span class="o">=</span> <span class="nf">MmGetPhysicalAddress</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sub_140001490</span> <span class="o">+</span> <span class="mi">7024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140013170</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="nf">MmMapIoSpace</span><span class="p">(</span><span class="n">PhysicalAddress</span><span class="p">,</span> <span class="mh">0x1000u</span><span class="n">i64</span><span class="p">,</span> <span class="n">MmNonCached</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140013178</span> <span class="o">=</span> <span class="n">qword_140013170</span> <span class="o">+</span> <span class="mi">48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v5</span> <span class="o">=</span> <span class="nf">MmGetPhysicalAddress</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sub_140001490</span> <span class="o">-</span> <span class="mi">96</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">qword_140013188</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="nf">MmMapIoSpace</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="mh">0x1000u</span><span class="n">i64</span><span class="p">,</span> <span class="n">MmNonCached</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">susBytes</span> <span class="o">=</span> <span class="n">qword_140013188</span> <span class="o">+</span> <span class="mi">1792</span><span class="p">;</span>
</span></span></code></pre></div><p>PhysicalAddress sẽ là biến lưu giá trị chính xác của (sub_140001490 + 7024) được lưu trong RAM, địa chỉ này được map 0x1000 bytes.</p>
<p>Có thể hiểu rằng khi được map như vậy, có một hàm nào năm trên vùng map thì khi các bits vật lí ở memory bị thay đổi đồng nghĩa với nội dung của hàm đó cũng bị thay đổi.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">qword_140013178</span> <span class="o">=</span> <span class="n">qword_140013170</span> <span class="o">+</span> <span class="mi">48</span><span class="p">;</span>
</span></span></code></pre></div><p>qword_70 lúc này là một vùng 0x1000 bytes, mà qword_78 trỏ tới qword_70 + 48, mà đồng thời độ dài của flag là 48 bytes =&gt; qword_70 là vùng nhớ của flag, mình sẽ rename lại thành <code>flag</code>, còn <code>qword_140013170</code> mình sẽ gọi là space1</p>
<p>Tương tự với 2 câu lệnh tiếp theo, đặc biệt địa chỉ của qword_140013188 + 1792 trùng với địa chỉ của hàm</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="kr">__fastcall</span> <span class="nf">sub_140001B30</span><span class="p">(</span><span class="kt">char</span> <span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">-</span><span class="mi">98</span> <span class="o">-</span> <span class="mi">17</span> <span class="o">*</span> <span class="p">((</span><span class="n">a1</span> <span class="o">-</span> <span class="mi">34</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Mình tạm gọi nó là space2, còn susBytes sẽ trỏ tới vị trí trong memory của hàm này. Nghĩa là khi susBytes thay đổi thì nội dung hàm cũng bị thay đổi.</p>
<p>Còn <code>qword_140013188</code> mình sẽ rename thành space2.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">susBytes</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">space2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">11</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">susBytes</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">17</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">19</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">21</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">22</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">25</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">26</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">27</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">28</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">13</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">29</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">30</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">susBytes</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">^=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">space2</span> <span class="o">+</span> <span class="mi">31</span><span class="p">);</span>
</span></span></code></pre></div><p>Ngay bên dưới thì hàm sub_140001B30 (tạm gọi là decrypt) đã bị xor với space2 và bị thay đổi, nhưng lúc này mình không biết space2 là gì và đoạn code này được chạy khi mà mình load driver xuống tầng kernel, do đó mình phải setup debug mới biết được space2 là gì.</p>
<p>Tiếp tục quay lại hàm <code>proc_func</code> là nơi xử lí chính của chương trình:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">proc_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">_DEVICE_OBJECT</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">PIO_STACK_LOCATION</span> <span class="n">CurrentIrpStackLocation</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// cl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">CurrentIrpStackLocation</span> <span class="o">=</span> <span class="nf">IoGetCurrentIrpStackLocation</span><span class="p">((</span><span class="n">PIRP</span><span class="p">)</span><span class="n">a2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">a1</span> <span class="o">!=</span> <span class="n">DeviceObject</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">3221225473</span><span class="n">i64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">CurrentIrpStackLocation</span><span class="o">-&gt;</span><span class="n">MajorFunction</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">CurrentIrpStackLocation</span><span class="o">-&gt;</span><span class="n">MajorFunction</span> <span class="o">==</span> <span class="mi">14</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Length</span> <span class="o">=</span> <span class="n">CurrentIrpStackLocation</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Read</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">switch</span> <span class="p">(</span> <span class="n">CurrentIrpStackLocation</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Read</span><span class="p">.</span><span class="n">ByteOffset</span><span class="p">.</span><span class="n">LowPart</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222000u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013190</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222010u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">32u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013191</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222020u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">64u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013192</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222030u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">96u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013193</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222040u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">128u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013194</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222050u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">160u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013195</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222060u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">192u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013196</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222070u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="nf">susFunc</span><span class="p">(</span><span class="mi">224u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">byte_140013197</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mh">0x222080u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">Length</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">LABEL_15</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">v7</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">while</span> <span class="p">(</span> <span class="n">byte_140013190</span><span class="p">[</span><span class="n">v8</span><span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span> <span class="o">++</span><span class="n">v8</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="k">goto</span> <span class="n">LABEL_21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">v7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL_21</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">v9</span> <span class="o">=</span> <span class="n">dword_140003000</span> <span class="o">-</span> <span class="err">&#39;</span><span class="n">ctih</span><span class="err">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span> <span class="n">dword_140003000</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">ctih</span><span class="err">&#39;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)</span><span class="n">word_140003004</span> <span class="o">-</span> <span class="err">&#39;</span><span class="n">no</span><span class="err">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">**</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">**</span><span class="p">)(</span><span class="n">a2</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">=</span> <span class="n">v9</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL_15</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="o">**</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">**</span><span class="p">)(</span><span class="n">a2</span> <span class="o">+</span> <span class="mi">24</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_140003170</span><span class="p">[(</span><span class="n">_QWORD</span><span class="p">)</span><span class="nf">PsGetCurrentProcessId</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a2</span> <span class="o">+</span> <span class="mi">56</span><span class="p">)</span> <span class="o">=</span> <span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a2</span> <span class="o">+</span> <span class="mi">48</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">IofCompleteRequest</span><span class="p">((</span><span class="n">PIRP</span><span class="p">)</span><span class="n">a2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Tại đây ta sẽ thấy cấu trúc của nó là 1 switch case, mà lúc nãy checker.exe có sử dụng code là 0x222080 =&gt; chỉ có <code>case 0x222080u</code> được gọi.</p>
<p>Ở case này thì nó check xem đã gọi 8 case ở trên chưa (0x222000-&gt;0x222070), Nếu có thì nó sẽ tiến hành kiểm tra dword_140003000 có bằng &ldquo;hitcon&rdquo; hay không, nếu có thì nó sẽ trả về byte 1 cho checker.exe</p>
<p>Tại bytes dword_140003000, ta thấy nó là flag</p>
<p>ed với length là 48 (lý do mình biết flaglength là 48 lúc nãy)</p>
<p><img src="https://i.imgur.com/f2FQcGy.png" alt=""></p>
<p>Quay lại các case ở trên, nó gọi 1 hàm duy nhất nhưng có tham số khác nhau</p>
<p><img src="https://i.imgur.com/yYFe804.png" alt=""></p>
<p>Trong hàm này nó xor function decrypt (susBytes) với 16 bytes đầu của space 1 kể từ idx sau đó nó dùng hàm <code>decrypt</code> để decrypt 48 bytes của flag, sau đó lại xor <code>decrypt</code> với 16 bytes tiếp theo kể tử idx+16.</p>
<h2 id="take-note">
<a class="header-anchor" href="#take-note"></a>
take note
</h2><p>Vậy thì cơ bản flow chương trình đã có thể rõ, có thể tóm tắt lại như sau:</p>
<ul>
<li>checker.exe có sử dụng driver check flag, khi flag trên driver đúng thì sẽ trả về correct</li>
<li>driver có 8 hàm xử lí flag và 1 hàm check (case 0x222080)</li>
<li>Khi mà driver gọi đủ 8 hàm trên thì mới kiểm tra flag được, trong mỗi hàm lần lượt xor bytes rồi gọi hàm decrypt flag, sau đó xor hàm decrypt flag tiếp</li>
</ul>
<h2 id="solution">
<a class="header-anchor" href="#solution"></a>
Solution
</h2><p>Vậy để được flag đúng, ta phải tìm được đúng thứ tự gọi 8 hàm ở trên, vậy việc đầu tiên là ta phải lấy được space1 và bytes của function decrypt sau khi chạy hết hàm main.</p>
<p>Giờ mình sẽ setup debug:</p>
<p>Máy ảo mình đang sử dụng là Windows 10 22H2 và flare-vm, tools dùng để debug là Windbg, vì ban đầu mình dùng windbg bản cũ nên là hầu như rất khó và không thể làm được. Mình dùng WinDbg Preview trên <code>Microsoft Store</code>.</p>
<p>Đầu tiên phải cài đặt được driver để test trước:</p>
<p>Mình dùng OSR Driver Loader để dùng GUI hoặc cũng có thể dựa theo <a href="https://stackoverflow.com/questions/7828663/how-do-i-install-a-custom-windows-driver">link này</a>:</p>
<p>Đối với OSR Driver Loader:</p>
<p><img src="https://i.imgur.com/fjrYKrv.png" alt=""></p>
<p>Chọn <code>[Resgiser Service]</code> để tạo service cho driver này, sau đó chọn <code>[Start Service]</code> để khởi động service, tương từ bấm stop và Unregister để dừng và huỷ bỏ.</p>
<p>Tương tự cách trên nhưng cùng cmd:</p>
<p>Register Service: <code>sc create hitcon_checker binPath= [full path to your .sys file] type= kernel</code></p>
<p>Start service: <code>sc start hitcon_checker</code></p>
<blockquote>
<p>Đối với các bạn không resgister được vì driver không có signature, hay nói cách khác Windows nói đó là driver không rõ nguồn gốc nên không cài được, tuy nhiên có thể tắt chức năng này khi khởi động windows, mình làm theo hướng dẫn ở link này hoặc các bạn có thể dùng <a href="https://github.com/4d61726b/VirtualKD-Redux">VirtualKD-Redux</a> -&gt; taget64 -&gt; vminstall.exe, Sau đó bấm F8 và chọn [Disable driver signature enforcement]</p></blockquote>
<p>Sau khi khởi động service thì khi chạy checker.exe sẽ có thông báo như sau là thành công:</p>
<p><img src="https://i.imgur.com/P5qG7Nt.png" alt=""></p>
<p>Tiến hành debug driver thôi, bây giờ các bạn làm lại bước <code>taget64 -&gt; vminstall.exe -&gt; install </code>, tiếp tục F8 và chọn [Disable driver signature enforcement] tuy nhiên cùng lúc này, khi mà Icon windows hiện lên thì ở máy host mở vmmon64.exe lên:</p>
<p><img src="https://i.imgur.com/6IoXMjc.png" alt=""></p>
<p>Chọn WinDbg Preview và Chọn [Run debugger]</p>
<p><img src="https://i.imgur.com/KPLVolL.png" alt=""></p>
<p>Lúc này setup màn hình disassembly và máy ảo đứng như thế này xem như thành công:v</p>
<p><img src="https://i.imgur.com/4VBruAn.png" alt=""></p>
<p>Bấm go để máy tiếp tục chạy</p>
<p><img src="https://i.imgur.com/c4dsopH.png" alt=""></p>
<p>Lúc này, khởi động lại driver của bài, nếu thành công ta sẽ thấy checker_drv.sys trong driver list:</p>
<p><img src="https://i.imgur.com/VRVGgOK.png" alt=""></p>
<p>Quay lại Windbg, dựa vào địa chỉ base của driver, tìm dược vị trí của driver đó trong memory:</p>
<p><img src="https://i.imgur.com/Z553fu3.png" alt=""></p>
<p>Dựa vào địa chỉ của hàm decrypt trong IDA, mình tìm được hàm <code>decrypt</code> trong màn hình memory là <code>base + 0x1b30</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="kr">__fastcall</span> <span class="nf">sub_140001B30</span><span class="p">(</span><span class="kt">char</span> <span class="n">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">-</span><span class="mi">98</span> <span class="o">-</span> <span class="mi">17</span> <span class="o">*</span> <span class="p">((</span><span class="n">a1</span> <span class="o">-</span> <span class="mi">34</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><img src="https://i.imgur.com/Er6xSsv.png" alt="">
Lúc này, rõ ràng nó đã đi qua hàm main nên bytes của nó đã bị thay đổi so với ban đầu, vì cần lưu bytes này lại tính toán, nên mình dùng lệnh db để lấy bytes này ra:</p>
<p><img src="https://i.imgur.com/bNhf02y.png" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">func</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;88 31 20 13 55 b4 4f 48 f3 18 4f 5b b0 29 9e c7 00 2a c1 c3&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Tương tự mình cần lấy ra 0xe0 + 32 bytes của space2</p>
<p><img src="https://i.imgur.com/6ilI7Bt.png" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">space2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">19 bc 8f 82 d0 2c 61 34 c0 9f f6 50 d5 fb 0c 6e
</span></span></span><span class="line"><span class="cl"><span class="s2">d0 eb e5 e3 ce b5 4c ca 45 aa 11 b2 3e 62 6f 7d
</span></span></span><span class="line"><span class="cl"><span class="s2">d0 eb a9 e3 b2 2f 06 47 7c 28 c5 de de 1a 4e d6
</span></span></span><span class="line"><span class="cl"><span class="s2">d8 2d 93 4f 82 65 64 fd 08 62 4b 87 7e 52 47 30
</span></span></span><span class="line"><span class="cl"><span class="s2">b7 ba d0 39 68 53 50 ab 20 d5 ca 84 26 71 6f 91
</span></span></span><span class="line"><span class="cl"><span class="s2">1b 36 46 11 a5 f1 4e 58 6c 74 d4 9c 15 e2 28 d5
</span></span></span><span class="line"><span class="cl"><span class="s2">d9 0f 3d 83 f3 fc d1 13 1a 62 12 40 aa ea cd cb
</span></span></span><span class="line"><span class="cl"><span class="s2">e1 c6 08 81 98 f6 68 88 be 23 b5 9e 55 b9 e2 7d
</span></span></span><span class="line"><span class="cl"><span class="s2">5a da 39 07 f0 2e 32 20 59 56 4c b4 8f 3e 07 61
</span></span></span><span class="line"><span class="cl"><span class="s2">d9 0f 2d 61 f1 91 33 14 cb 49 68 fe 1f d4 8a fe
</span></span></span><span class="line"><span class="cl"><span class="s2">e1 c6 18 63 9a 9b 8a 8a 7f 08 c3 e8 e1 ec 0b 8f
</span></span></span><span class="line"><span class="cl"><span class="s2">3b 00 94 a5 11 e7 47 66 c4 9f 98 18 70 f0 30 f6
</span></span></span><span class="line"><span class="cl"><span class="s2">94 71 b1 95 d1 f0 6f b7 d9 3d 05 9e c1 53 33 76
</span></span></span><span class="line"><span class="cl"><span class="s2">9b 4b 69 ca de fd 7d 67 b8 29 2b c7 c5 84 2c d1
</span></span></span><span class="line"><span class="cl"><span class="s2">87 87 f1 98 97 74 ad 4b 32 f0 4a 51 72 ea 09 f7
</span></span></span><span class="line"><span class="cl"><span class="s2">38 fd 27 bd 1c 52 71 43 95 9c 1a 86 f2 c0 f9 f8&#34;&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Tới đây thì mình có thể tìm thứ tự các hàm trong switch case hoạt động bằng cách bruteforce các opcode các hàm, vì sau khi xử lí xong, các bytes của hàm bị biến đổi sau cho có thể sử dụng được hàm sau sử dụng được, nên tổng số lần mình cần brute rất ít (2+3+4+5+6+7+8) = 35 lần</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="c1"># print(xor(x2[:16],b2[:16]).hex() + x2[16:].hex())</span>
</span></span><span class="line"><span class="cl"><span class="c1">#important offset</span>
</span></span><span class="line"><span class="cl"><span class="c1">#0xfffff80664800000</span>
</span></span><span class="line"><span class="cl"><span class="c1">#1b30 miniencrypt</span>
</span></span><span class="line"><span class="cl"><span class="c1">#3000 flag</span>
</span></span><span class="line"><span class="cl"><span class="c1"># origin = b&#39;\x80\xe9&#34;\x80\xf1\xad\x0f\xb6\xc1k\xc8\x11\xb8\x9e\x00\x00\x00*\xc1\xc3&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">func</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;88 31 20 13 55 b4 4f 48 f3 18 4f 5b b0 29 9e c7 00 2a c1 c3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">space2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">19 bc 8f 82 d0 2c 61 34 c0 9f f6 50 d5 fb 0c 6e
</span></span></span><span class="line"><span class="cl"><span class="s2">d0 eb e5 e3 ce b5 4c ca 45 aa 11 b2 3e 62 6f 7d
</span></span></span><span class="line"><span class="cl"><span class="s2">d0 eb a9 e3 b2 2f 06 47 7c 28 c5 de de 1a 4e d6
</span></span></span><span class="line"><span class="cl"><span class="s2">d8 2d 93 4f 82 65 64 fd 08 62 4b 87 7e 52 47 30
</span></span></span><span class="line"><span class="cl"><span class="s2">b7 ba d0 39 68 53 50 ab 20 d5 ca 84 26 71 6f 91
</span></span></span><span class="line"><span class="cl"><span class="s2">1b 36 46 11 a5 f1 4e 58 6c 74 d4 9c 15 e2 28 d5
</span></span></span><span class="line"><span class="cl"><span class="s2">d9 0f 3d 83 f3 fc d1 13 1a 62 12 40 aa ea cd cb
</span></span></span><span class="line"><span class="cl"><span class="s2">e1 c6 08 81 98 f6 68 88 be 23 b5 9e 55 b9 e2 7d
</span></span></span><span class="line"><span class="cl"><span class="s2">5a da 39 07 f0 2e 32 20 59 56 4c b4 8f 3e 07 61
</span></span></span><span class="line"><span class="cl"><span class="s2">d9 0f 2d 61 f1 91 33 14 cb 49 68 fe 1f d4 8a fe
</span></span></span><span class="line"><span class="cl"><span class="s2">e1 c6 18 63 9a 9b 8a 8a 7f 08 c3 e8 e1 ec 0b 8f
</span></span></span><span class="line"><span class="cl"><span class="s2">3b 00 94 a5 11 e7 47 66 c4 9f 98 18 70 f0 30 f6
</span></span></span><span class="line"><span class="cl"><span class="s2">94 71 b1 95 d1 f0 6f b7 d9 3d 05 9e c1 53 33 76
</span></span></span><span class="line"><span class="cl"><span class="s2">9b 4b 69 ca de fd 7d 67 b8 29 2b c7 c5 84 2c d1
</span></span></span><span class="line"><span class="cl"><span class="s2">87 87 f1 98 97 74 ad 4b 32 f0 4a 51 72 ea 09 f7
</span></span></span><span class="line"><span class="cl"><span class="s2">38 fd 27 bd 1c 52 71 43 95 9c 1a 86 f2 c0 f9 f8&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">space2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">space2</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#0 32 224</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decryptflag</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpFunc</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">func</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span><span class="n">space2</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">16</span><span class="p">])</span> <span class="o">+</span> <span class="n">func</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">tmpFunc</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpFunc</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">tmpFunc</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span><span class="n">space2</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">16</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">32</span><span class="p">])</span> <span class="o">+</span> <span class="n">func</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tmpFunc</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">192</span><span class="p">,</span><span class="mi">224</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">decryptflag</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0 918daf9185982e7c3387b90b65d292a9002ac1c3                                                                                         
</span></span><span class="line"><span class="cl">32 58da89f0e79b490f8f308a856e33d011002ac1c3                                                                                       
</span></span><span class="line"><span class="cl">64 3f8bf02a3de71fe3d3cd85df9658f156002ac1c3
</span></span><span class="line"><span class="cl">96 513e1d90a6489e5be97a5d1b1ac3530c002ac1c3
</span></span><span class="line"><span class="cl">128 d2eb1914a59a7d68aa4e03ef3f1799a6002ac1c3
</span></span><span class="line"><span class="cl">160 69f73870cf2fc5c28c108cb351c59548002ac1c3
</span></span><span class="line"><span class="cl">192 1c409186844420ff2a254ac5717aadb1002ac1c3
</span></span><span class="line"><span class="cl">224 0fb6d18bc2c0e203c1e8050ac2c39730002ac1c3
</span></span></code></pre></div><p>Thử 8 shellcode này trên <a href="https://onlinedisassembler.com/odaweb/">https://onlinedisassembler.com/odaweb/</a> thì mình thấy 224 là hợp lí nhất, tương ứng với code 0x222070u</p>
<p><img src="https://i.imgur.com/yT4Fhgp.png" alt=""></p>
<p>Tương tự với 27 lần nữa, mình tìm được thứ tự rất hợp lí khi mà hàm cuối khi disassembly như này:</p>
<p><img src="https://i.imgur.com/3F1Mgn4.png" alt=""></p>
<p>Đây là thứ tự của các tham số:</p>
<p><code>[224,64,192,0,32,128,96,160]</code></p>
<p>Tương ứng với các code \</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[0x222070u,0x222020u,0x222050u,0x222000u,0x222010u,0x222040u,0x222030u,0x222060u]
</span></span></code></pre></div><p>Để gửi các code này lên driver thì mình có 1 cách là tạo ra 8 cái file khác nhau, mỗi file có 1 số 0x2220_0 thay đổi từ file gốc là</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">FileW</span><span class="p">,</span> <span class="mh">0x222080u</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OutBuffer</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span> <span class="mi">0</span><span class="n">i64</span><span class="p">);</span>
</span></span></code></pre></div><p>Đây là script của mình</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;checker.exe&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for i in range(len(b)-5):</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     if b[i:i+5]==b&#39;\xba\x80\x20\x22\x00&#39;:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#         print(i)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1290</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">192</span><span class="p">,</span><span class="mi">224</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x10</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x20</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x30</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x40</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x50</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x60</span><span class="s1">&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x70</span><span class="s1">&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;checker</span><span class="si">{</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">.exe&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">[:</span><span class="mi">1290</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">b</span><span class="p">[</span><span class="mi">1291</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmpFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
</span></span></code></pre></div><p><img src="https://i.imgur.com/a49jjGL.png" alt=""></p>
<p>Load file vào Máy ảo và chạy lần lượt theo thứ tự ở trên, nếu thành công, khi chạy file checker.exe nó sẽ thông báo như thế này:</p>
<p><img src="https://i.imgur.com/OCkQzsG.png" alt=""></p>
<p>Đồng nghĩa là flag đã đúng và nằm trong memory.</p>
<p>Check địa chỉ base + 0x3000 ta sẽ thấy flag:</p>
<p><img src="https://i.imgur.com/HVLwiVt.png" alt=""></p>
<p>Flag: <code>hitcon{r3ally_re4lly_rea11y_normal_checker}</code></p>
<h1 id="meow-way---193pts">
<a class="header-anchor" href="#meow-way---193pts"></a>
Meow Way - 193pts
</h1><p>Về cơ bản thì bài này dễ hơn bài trước khá nhiều flow cũng dễ đọc hơn, chỉ khác là nó áp dụng một kĩ thuật đặc biệt có tên là <a href="https://www.malwarebytes.com/blog/news/2018/01/a-coin-miner-with-a-heavens-gate">heaven&rsquo;s gate</a> mình biết được từ a @mochi và anh gửi cho mình blog này.</p>
<p>Trước hết xem qua thử file duy nhất mà đề bài cho mình:</p>
<p>Load file bằng IDA32 và đây là toàn bộ hàm main của nó</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-24h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-24h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-10h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v7</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// [esp+18h] [ebp-Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v7</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sub_401340</span><span class="p">(</span><span class="s">&#34;Usage: %s &lt;flag&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">48</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sub_401340</span><span class="p">(</span><span class="s">&#34;Wrong length</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_40544C</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_4053A8</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_4053B4</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_4053F0</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_405448</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_405428</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_405460</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_40540C</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">++</span><span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_4053F4</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">v6</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">dword_405438</span><span class="p">(</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="n">v6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v7</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v5</span> <span class="o">=</span> <span class="nf">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_405018</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0x30u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sub_401340</span><span class="p">(</span><span class="s">&#34;Wrong</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">sub_401340</span><span class="p">(</span><span class="s">&#34;I know you know the flag!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Đầu tiên là chương trình check length của flag xem có bằng 48 kí tự không, sau đó thì với mỗi kí tự có 1 hàm encrypt riêng biệt với các tham số khác nhau.</p>
<p>Sau cùng là compare với unk_405018(encryted flag) và thông báo kết quả.</p>
<p>Từng dword_* sẽ trỏ về 1 hàm bất kì:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sub_401060</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">dword_405400</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="kr">__cdecl</span> <span class="o">*</span><span class="p">)(</span><span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">,</span> <span class="n">_DWORD</span><span class="p">))</span><span class="s">&#34;j3è&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Và đây là nội dung của hàm đó:</p>
<p><img src="https://i.imgur.com/vHenZ2B.png" alt=""></p>
<p>Lúc này mình thử debug mới xem được từng hàm nó làm gì:
Set Parameter là 1 chuỗi bất kì có lenght = 48</p>
<p><img src="https://i.imgur.com/l6DNkpd.png" alt=""></p>
<p><img src="https://i.imgur.com/qJfOtA8.png" alt=""></p>
<p>Khi mình stepinto và đi hết đoạn này thì chương trình tự out luôn, chắc là có lỗi gì đó ở chổ này</p>
<p>Nếu kiểm tra kĩ, ta sẽ thấy phía dưới thực sự còn 1 đoạn code nữa nhưng nó không chạy</p>
<p><img src="https://i.imgur.com/VKabHAP.png" alt=""></p>
<p>Mình thử kiểm tra tương tự với các hàm khác, thì nó cũng ra kết quả tương tự, tuy nhiên chỉ khác nhau một vài chổ như <code>xor cl, &lt;num&gt;</code>, và một số hàm sub thay vì add, &hellip;</p>
<p>Cơ bản là đoạn code phía trên làm nhiễu khá nhiều, khiến mình không thực sự biết là nó thực sự làm gì.</p>
<p>Như đầu bài mình đã nói, file này là file PE32 nhưng dùng kĩ thuật <code>heaven's gate</code> nên đoạn đó nó có thể chạy được code của 64bits (mình biết sơ như vậy:v). Do đó đoạn shellcode phía sau là của 64bit. Mình dùng web này để disassemble:</p>
<p><a href="https://onlinedisassembler.com/odaweb/">onlinedisassembler</a></p>
<p>Đối với function đầu tiên:</p>
<p><img src="https://i.imgur.com/v4EMYz9.png" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">6a33e80000000083042405cb4831c065488b4060480fb64002678b4c241c67890185c07518678b7c2404678b74240c678b4c241467020e80f1ba67880fe800000000c7442404230000008304240dcbc30000000000000000
</span></span></code></pre></div><p><img src="https://i.imgur.com/XdXqHaj.png" alt=""></p>
<p>Có một điều thú vị là kĩ thuật này chỉ anti debug thui, còn đọc thì cơ bản vẫn đọc được =)), thế mà không hiểu sao lúc đầu đọc không ra, chuyển qua x64 cũng thấy không khác gì nhiều nhưn mà lại làm ra =)), tâm lí quá.</p>
<p>Mình chỉ cần quan trọng đoạn này thôi:</p>
<p><img src="https://i.imgur.com/ts4J1xW.png" alt=""></p>
<p>dựa vào thanh ghi esi, edi, và cl có thể suy ra nó encrypt byte của flag như sau:</p>
<p><img src="https://i.imgur.com/GUc0nTE.png" alt=""></p>
<p>Đối với hàm này thì sẽ dịch sang python như này:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">encrypted</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">para</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">^</span><span class="n">func</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span>
</span></span></code></pre></div><p>Tương tự với các hàm cho đến khi hàm thứ 6 thì nó sẽ khác đi 1 chút là thay vì cộng sẽ hành phép trừ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">encrypted</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">para</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">^</span><span class="n">func</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span>
</span></span></code></pre></div><p>Tới đây mình thử giải ra flag</p>
<p>Trước tiên mình cần phải có tất cả các tham số mà nó truyền vào và flag encrypted:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">para</span><span class="o">=</span><span class="p">[</span><span class="mi">196</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mi">251</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">218</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mi">239</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">197</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">143</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">237</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">249</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mi">101</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypted</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x96</span><span class="s2">P</span><span class="se">\xcf</span><span class="s2">,</span><span class="se">\xeb\x9b\xaa\xfb</span><span class="s2">S</span><span class="se">\xab</span><span class="s2">s</span><span class="se">\xdd</span><span class="s2">l</span><span class="se">\x9e\xdb\xbc\xee\xab</span><span class="s2">#</span><span class="se">\xd6\x16\xfd\xf1\xf0\xb9</span><span class="s2">u</span><span class="se">\xc3</span><span class="s2">(</span><span class="se">\xa2</span><span class="s2">t}</span><span class="se">\xe3</span><span class="s2">&#39;</span><span class="se">\xd5\x95\\\xf5</span><span class="s2">vu</span><span class="se">\xc9\x8c\xfb</span><span class="s2">B</span><span class="se">\x0e\xbd</span><span class="s2">Q</span><span class="se">\xa2\x98</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>Tiếp theo là tìm cách lấy các tham số nằm bên trong hàm:</p>
<p><img src="https://i.imgur.com/2NDMnlw.png" alt=""></p>
<p>Dựa vào các địa chỉ này, ta lấy 4 bytes đầu là được địa chỉ của hàm</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Từ 4 bytes này mình sẽ lấy được toàn bộ hàm, tuy nhiên ta chỉ cần lấy bytes mà lúc nó xor, dựa vào opcode và thanh ghi của lệnh <code>xor cl, &lt;num&gt;</code>, mình biết được chỉ cần lấy byte nằm sau b&rsquo;\xf1&rsquo; là có được số cần xor.</p>
<p>Tới đây chỉ cần rev lại 2 hàm sub và add rồi decrypt flag ra thôi:v.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">encrypted</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x96</span><span class="s2">P</span><span class="se">\xcf</span><span class="s2">,</span><span class="se">\xeb\x9b\xaa\xfb</span><span class="s2">S</span><span class="se">\xab</span><span class="s2">s</span><span class="se">\xdd</span><span class="s2">l</span><span class="se">\x9e\xdb\xbc\xee\xab</span><span class="s2">#</span><span class="se">\xd6\x16\xfd\xf1\xf0\xb9</span><span class="s2">u</span><span class="se">\xc3</span><span class="s2">(</span><span class="se">\xa2</span><span class="s2">t}</span><span class="se">\xe3</span><span class="s2">&#39;</span><span class="se">\xd5\x95\\\xf5</span><span class="s2">vu</span><span class="se">\xc9\x8c\xfb</span><span class="s2">B</span><span class="se">\x0e\xbd</span><span class="s2">Q</span><span class="se">\xa2\x98</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">para</span><span class="o">=</span><span class="p">[</span><span class="mi">196</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mi">251</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">218</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span><span class="mi">239</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">87</span><span class="p">,</span><span class="mi">92</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">197</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">143</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="mi">237</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">249</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mi">101</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x77544C</span><span class="p">,</span><span class="mh">0x7753A8</span><span class="p">,</span><span class="mh">0x7753B4</span><span class="p">,</span><span class="mh">0x7753F0</span><span class="p">,</span><span class="mh">0x775448</span><span class="p">,</span><span class="mh">0x7753FC</span><span class="p">,</span><span class="mh">0x775400</span><span class="p">,</span><span class="mh">0x775410</span><span class="p">,</span><span class="mh">0x7753F8</span><span class="p">,</span><span class="mh">0x775430</span><span class="p">,</span><span class="mh">0x7753D0</span><span class="p">,</span><span class="mh">0x775434</span><span class="p">,</span><span class="mh">0x77545C</span><span class="p">,</span><span class="mh">0x775454</span><span class="p">,</span><span class="mh">0x7753C0</span><span class="p">,</span><span class="mh">0x7753E4</span><span class="p">,</span><span class="mh">0x7753C4</span><span class="p">,</span><span class="mh">0x775440</span><span class="p">,</span><span class="mh">0x7753BC</span><span class="p">,</span><span class="mh">0x7753AC</span><span class="p">,</span><span class="mh">0x775408</span><span class="p">,</span><span class="mh">0x7753D8</span><span class="p">,</span><span class="mh">0x7753B8</span><span class="p">,</span><span class="mh">0x7753C8</span><span class="p">,</span><span class="mh">0x7753E0</span><span class="p">,</span><span class="mh">0x775418</span><span class="p">,</span><span class="mh">0x7753EC</span><span class="p">,</span><span class="mh">0x775414</span><span class="p">,</span><span class="mh">0x775450</span><span class="p">,</span><span class="mh">0x7753E8</span><span class="p">,</span><span class="mh">0x7753D4</span><span class="p">,</span><span class="mh">0x77541C</span><span class="p">,</span><span class="mh">0x77542C</span><span class="p">,</span><span class="mh">0x775444</span><span class="p">,</span><span class="mh">0x775458</span><span class="p">,</span><span class="mh">0x775420</span><span class="p">,</span><span class="mh">0x7753B0</span><span class="p">,</span><span class="mh">0x7753DC</span><span class="p">,</span><span class="mh">0x775464</span><span class="p">,</span><span class="mh">0x7753CC</span><span class="p">,</span><span class="mh">0x775424</span><span class="p">,</span><span class="mh">0x77543C</span><span class="p">,</span><span class="mh">0x775404</span><span class="p">,</span><span class="mh">0x775428</span><span class="p">,</span><span class="mh">0x775460</span><span class="p">,</span><span class="mh">0x77540C</span><span class="p">,</span><span class="mh">0x7753F4</span><span class="p">,</span><span class="mh">0x775438</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#[get_bytes(int.from_bytes(get_bytes(i,4),&#39;little&#39;) + 0x30,16) for i in offset]</span>
</span></span><span class="line"><span class="cl"><span class="n">func</span> <span class="o">=</span> <span class="p">[</span><span class="mi">186</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">112</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">para</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">encrypted</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">para</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">^</span><span class="n">func</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="o">==</span><span class="n">encrypted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">^</span><span class="n">b</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="o">==</span><span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag</span><span class="o">+=</span><span class="nb">chr</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">encrypted</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag</span><span class="o">+=</span><span class="nb">chr</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">func</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">encrypted</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#hitcon{___7U5T_4_S1mpIE_xB6_M@G1C_4_mE0w_W@y___}</span>
</span></span></code></pre></div><p>Sorry mọi người vì lúc đó mình làm ngược lại không ra mà mình gấp quá nên dùng cách brute luôn =))).</p>
<p>Flag: <code>hitcon{___7U5T_4_S1mpIE_xB6_M@G1C_4_mE0w_W@y___}</code></p>

      
    </div>
    <footer class="article-footer">
      

      
        <div class="sponsor-wrapper">
  <div class="sponsor-button-wrapper">
    <div class="sponsor-icon rotate"></div>
    <div class="sponsor-title">Sponsor</div>
    <div class="sponsor-icon rotate"></div>
  </div>
  <div class="sponsor-tip">Please buy author a cup of coffee!</div>
  
    <div class="sponsor-qr">
      
        <div class="sponsor-qr-image-wrapper">
          <img src="/images/bmc_qr_lephuduc.png" alt="Le Phu Duc" width="200" />
          <p class="sponsor-qr-name">Le Phu Duc</p>
        </div>
      
    </div>
  
</div>
      

      
        

<div class="share-wrapper">
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:1313/post/hitconctf2022/" target="_blank" rel="noopener noreferrer" title="HITCON CTF 2022">
      <div class="share-icon icon icon-facebook">
        
      </div>
    </a>
  
    <a href="https://twitter.com/intent/tweet?url=http://localhost:1313/post/hitconctf2022/&amp;text=HITCON%20CTF%202022&amp;via=http://localhost:1313/" target="_blank" rel="noopener noreferrer" title="HITCON CTF 2022">
      <div class="share-icon icon icon-twitter">
        
      </div>
    </a>
  
    <a href="https://www.linkedin.com/shareArticle?url=http://localhost:1313/post/hitconctf2022/&amp;title=HITCON%20CTF%202022&amp;summary=Write%20up%20for%20rev%20problem%20in%20HITCON%20CTF%202022&amp;mini=true&amp;ro=true" target="_blank" rel="noopener noreferrer" title="HITCON CTF 2022">
      <div class="share-icon icon icon-linkedin">
        
      </div>
    </a>
  
    <a href="https://www.reddit.com/submit?url=http://localhost:1313/post/hitconctf2022/&amp;title=HITCON%20CTF%202022" target="_blank" rel="noopener noreferrer" title="HITCON CTF 2022">
      <div class="share-icon icon icon-reddit">
        
      </div>
    </a>
  
</div>
      

      

      

      

      

      
      <ul class="article-tag-list" itemprop="keywords">
  
    <li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/reverse"
        rel="tag"
        >REVERSE</a
      >
    </li>
  
    <li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/vietnamese"
        rel="tag"
        >VIETNAMESE</a
      >
    </li>
  
</ul>

    </footer>
  </div>
  
    
  <nav
    id="article-nav"
    data-aos="fade-up"
  >
    
      <div class="article-nav-link-wrap article-nav-link-left">
        
          <img
            data-src="/images/post_covers/hackluctf2022-ori.jpeg"
            data-sizes="auto"
            alt="Hack.lu CTF 2022"
            class="lazyload"
          />
        
        <a href="http://localhost:1313/post/hackluctf2022/"></a>
        <div class="article-nav-caption">Newer</div>
        <h3 class="article-nav-title">
          
            Hack.lu CTF 2022
          
        </h3>
      </div>
    

    
      <div class="article-nav-link-wrap article-nav-link-right">
        
          <img
            data-src="/images/post_covers/plaidctf2023-ori.jpeg"
            data-sizes="auto"
            alt="The Plaid Flag CTF 2023"
            class="lazyload"
          />
        
        <a href="http://localhost:1313/post/plaidctf2023/"></a>
        <div class="article-nav-caption">Older</div>
        <h3 class="article-nav-title">
          
            The Plaid Flag CTF 2023
          
        </h3>
      </div>
    
  </nav>


  
</article>










</section>
        </div>
        
        
        



  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  



<footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    <div>
      <span class="icon-copyright"></span>
      2022 -
      2025
      <span class="footer-info-sep rotate"></span>
      Le Phu Duc
    </div>
    
    
    
      <div>
        <span class="icon-brush"
          >&nbsp;
            51.0k
          </span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;
          
          

          04:07
        </span>
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv"
          >Number of visits&nbsp;<span
            id="busuanzi_value_site_pv"
          ></span
        ></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv"
          >Number of visitors&nbsp;<span
            id="busuanzi_value_site_uv"
          ></span
        ></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar">
        <div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#file-checkerexe">file checker.exe</a></li>
    <li><a href="#file-checker_drvsys">file checker_drv.sys</a></li>
    <li><a href="#take-note">take note</a></li>
    <li><a href="#solution">Solution</a></li>
  </ul>
</nav>
  </div>
</div>
      </div>
      <div class="sidebar-common-sidebar hidden">
        
<div class="sidebar-author">
  <img
    data-src="/avatar/shiba.jpg"
    data-sizes="auto"
    alt="Le Phu Duc"
    class="lazyload"
  />
  <div class="sidebar-author-name">Le Phu Duc</div>
  <div class="sidebar-description">a.k.a Jinn</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    
    <div class="sidebar-state-number">16</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">
      1
    </div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">6</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-discord sidebar-social-icon">
      <a
        href="https://discordapp.com/users/lephuduc"
        itemprop="url"
        target="_blank"
        aria-label="discord"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-facebook sidebar-social-icon">
      <a
        href="https://www.facebook.com/lephuduc0309"
        itemprop="url"
        target="_blank"
        aria-label="facebook"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/lephuduc"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-instagram sidebar-social-icon">
      <a
        href="https://www.instagram.com/le.phuduc"
        itemprop="url"
        target="_blank"
        aria-label="instagram"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-linkedin sidebar-social-icon">
      <a
        href="https://www.linkedin.com/in/lephuduc"
        itemprop="url"
        target="_blank"
        aria-label="linkedin"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-twitter sidebar-social-icon">
      <a
        href="https://twitter.com/lephuduck"
        itemprop="url"
        target="_blank"
        aria-label="twitter"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe632;
        
      </div>
      <div class="sidebar-menu-link">Home</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/about"
        aria-label="About"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe628;
        
      </div>
      <div class="sidebar-menu-link">About</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe604;
        
      </div>
      <div class="sidebar-menu-link">Archives</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/achievements"
        aria-label="Achievements"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe621;
        
      </div>
      <div class="sidebar-menu-link">Achievements</div>
    </div>
  
</div>

      </div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
    






  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    
    
    
    
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"
  ></script>




  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    
    
    
    
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"
  ></script>









  
      
      <script src="/js/main.js" ></script>
      



  





  
      
      <script src="/js/aos.js" ></script>
      

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script>








  
      
      <script src="/js/pjax_main.js" data-pjax></script>
      





  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/mouse-firework@0.1.0/dist/index.umd.js"
    
    
    
    
    integrity="sha384-KM6i7tu43nYd6e0beIljxHMC5tZc58XBDu7pPA58w50h18Jsx7gLdimfS09RXlKv" crossorigin="anonymous"
  ></script>


<script>
  if (window.firework) {
    const options = JSON.parse("{\"excludeelements\":[\"a\",\"button\"],\"particles\":[{\"colors\":[\"#c0971d\",\"#caa02f\",\"#d4aa40\",\"#ddbb62\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"emit\"],\"number\":20,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.3,0.5],\"radius\":[16,32]}},{\"colors\":[\"#f4e74d\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"diffuse\"],\"number\":1,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.2,0.5],\"lineWidth\":6,\"radius\":20}}]}");
    options.excludeElements = options.excludeelements;
    delete options.excludeelements;
    window.firework(options);
  }
</script>



  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/theme-shokax-pjax@0.0.3/dist/index.umd.js"
    
    
    
    
    integrity="sha384-xneY1WY8hOfUzswrE4CrYq35N4BdVcxqxwHPr9zawE/jMSCxD&#43;jAPU55x/jj3wlf" crossorigin="anonymous"
  ></script>


  <script>
    function loadScripts(scripts, index) {
      if (index < scripts.length) {
        const script = scripts[index];
        const src = script.getAttribute('src');

        const loadScript = (scriptContent) => {
          return new Promise((resolve, reject) => {
            const scriptElement = document.createElement('script');
            if (script.type) {
              scriptElement.type = script.type;
            }
            if (script.src) {
              scriptElement.src = script.src;
              scriptElement.onload = resolve;
              scriptElement.onerror = reject;
            }
            if (scriptContent) {
              scriptElement.text = scriptContent;
            }
            document.head.appendChild(scriptElement);
            if (!script.src) {
              resolve();
            }
          })
          
        }

        ;(src ? loadScript() : loadScript(script.text))
          .then(() => loadScripts(scripts, index + 1))
          .catch(error => {
            console.error(`Failed to load script: ${src || 'inline script'}`, error);
            loadScripts(scripts, index + 1);
          });
      }
    }
    window.Pjax &&
      new window.Pjax({
        selectors: [
          "#header>img",
          "#header>picture",
          "head title",
          "#header-title",
          "#subtitle-wrap",
          "#main",
          "#content",
          ".sidebar-widget",
          ".sidebar-wrapper",
          "#mobile-nav",
          "#lazy-script",
        ],
        switches: {
          "#content": function(oldEl, newEl) {
            
            oldEl.className = newEl.className;
            this.onSwitch();
          },
          "#header-title": Pjax.switches.outerHTML,
          "#subtitle-wrap": Pjax.switches.outerHTML,
          "#main": function (oldEl, newEl) {
            const scripts = [...newEl.querySelectorAll("script")];
            loadScripts(scripts, 0);
            oldEl.outerHTML = newEl.outerHTML;
            this.onSwitch();
          },
          "#mobile-nav": Pjax.switches.outerHTML,
          "#lazy-script": function (oldEl, newEl) {
            const scripts = [...newEl.querySelectorAll("script")];
            loadScripts(scripts, 0);
            oldEl.innerHTML = newEl.innerHTML;
            this.onSwitch();
          },
        },
        cacheBust: false,
      });
  </script>
  





  
      
      <script src="/js/pjax.js" ></script>
      







<div id="lazy-script">
  <div>
    
      
      
        
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "Le Phu Duc",
          title: "HITCON CTF 2022",
          url: "http:\/\/localhost:1313\/post\/hitconctf2022\/",
          description: "Write up for rev problem in HITCON CTF 2022",
          cover: "http:\/\/localhost:1313\/images\/post_covers\/hitconctf2022.jpeg",
        };
      </script>
    
    
    
      





  
      
      <script src="/js/insert_highlight.js" data-pjax></script>
      

      
      
      
      
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;

        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      












      
    
    
  </div>
</div>




  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js"
    
    async
    
    
    integrity="sha384-0M75wtSkhjIInv4coYlaJU83&#43;OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id&#43;S" crossorigin="anonymous"
  ></script>





  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script>


<script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script>


  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/aplayer@1.10.1/dist/APlayer.min.js"
    
    
    
    
    integrity="sha384-gdGYZwHnfJM54evoZhpO0s6ZF5BQiybkiyW7VXr&#43;h5UfruuRL/aORyw&#43;5&#43;HZoU6e" crossorigin="anonymous"
  ></script>


  
    <script>
      const ap = new APlayer({
          theme: "var(--color-link)",
          container: document.getElementById('aplayer'),
          audio: JSON.parse("[{\"artist\":\"NewJeans\",\"cover\":\"/images/song_covers/ditto.jpg\",\"name\":\"Ditto\",\"url\":\"/songs/ditto.mp3\"},{\"artist\":\"NewJeans\",\"cover\":\"/images/song_covers/eta.jpg\",\"name\":\"ETA\",\"url\":\"/songs/ETA.mp3\"}]") || [],
          fixed:  null  || false,
          autoplay:  null  || false,
          loop: '' || 'all',
          order: '' || 'list',
          preload: '' || 'auto',
          volume:  null  || 0.7,
          mutex:  null  || true,
          listFolded:  null  || false,
          lrcType:  null  || 0,
      });
    </script>
  



  </body>
</html>
